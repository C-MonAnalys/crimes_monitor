import{v as A}from"./chunk-GOJ2ZNOE.js";import{R as v,V as j,f as u}from"./chunk-QQS62GLD.js";var S=class b{constructor(r){this.http=r;let t=document.getElementsByTagName("base")[0],s=t&&t.getAttribute("href")||"/";this.base=s.endsWith("/")?`${s}assets/data/sentiment`:`${s}/assets/data/sentiment`}base;fetchJson(r){return u(this,null,function*(){try{let t=yield fetch(`${this.base}/${r}`);return t.ok?t.json():null}catch(t){return console.error("SentimentService.fetchJson error",r,t),null}})}getDatasets(){return u(this,null,function*(){return this.fetchJson("datasets.json")})}loadDataset(r){return u(this,null,function*(){let t=yield this.getDatasets();if(!t||!t[r])throw new Error(`Dataset com o ID '${r}' n\xE3o foi encontrado.`);let s=t[r],e=s.bootstrapFile,n=s.commentsFile;if(!e||!n)throw new Error(`Configura\xE7\xE3o de ficheiros incompleta para o dataset '${r}'.`);let i=e.replace("data/",""),a=n.replace("data/",""),[l,c]=yield Promise.all([this.fetchJson(i),this.fetchJson(a)]);return{bootstrap:Array.isArray(l)?l:[],comments:Array.isArray(c)?c:[]}})}listAll(){return u(this,null,function*(){let[r,t,s]=yield Promise.all([this.fetchJson("datasets.json"),this.fetchJson("bootstrap_results_211124.json"),this.fetchJson("comentarios_2021_nordeste_newBERT.json")]);return{datasets:r??{},bootstrap:Array.isArray(t)?t:[],comments:Array.isArray(s)?s:[]}})}getTrainingStats(){return u(this,null,function*(){let r=document.getElementsByTagName("base")[0],t=r&&r.getAttribute("href")||"/",s=t.endsWith("/")?t:t+"/",e=`${s}assets/data/sentiment/treinamento_model_211124.json`,n=`${s}assets/data/sentiment/bootstrap_results_211124.json`,i=[];try{let o=yield fetch(e);o.ok&&(i=yield o.json())}catch(o){console.warn("[SentimentService.getTrainingStats] Falha ao ler treino \xFAnico:",o)}if(!Array.isArray(i)||!i.length)try{let[o,m]=yield Promise.all([this.http.get("assets/data/sentiment/train_labels.json").toPromise(),this.http.get(n).toPromise()]);return{total:Object.values(o||{}).reduce((w,_)=>w+_,0)||0,period:"\u2014",labels:o||{"-1":0,0:0,1:0},bootstrap:m||[],quality:{avgLen:0,medianLen:0,pShort:0}}}catch(o){return console.warn("[SentimentService.getTrainingStats] Fallback antigo indispon\xEDvel:",o),{total:0,period:"\u2014",labels:{"-1":0,0:0,1:0},bootstrap:[],quality:{avgLen:0,medianLen:0,pShort:0}}}let a={"-1":0,0:0,1:0},l=[],c=0;for(let o of i){let m=String(o?.rotulo??"0");a[m]===void 0&&(a[m]=0),a[m]++;let y=(o?.comentario??"").trim().length;l.push(y),y<30&&c++}let p=i.length,f=p?Math.round(l.reduce((o,m)=>o+m,0)/p):0,h=(()=>{let o=l.slice().sort((y,w)=>y-w);if(!o.length)return 0;let m=Math.floor(o.length/2);return o.length%2?o[m]:Math.round((o[m-1]+o[m])/2)})(),d=p?Math.round(c/p*100):0,g=[];try{let o=yield fetch(n);o.ok&&(g=yield o.json())}catch(o){console.warn("[SentimentService.getTrainingStats] Bootstrap indispon\xEDvel:",o)}return{total:p,period:"\u2014",labels:a,bootstrap:Array.isArray(g)?g:[],quality:{avgLen:f,medianLen:h,pShort:d}}})}getSentimentCounts(r){let t={"-1":0,0:0,1:0};for(let s of r){let e=String(s.new_BERT??"0");t[e]===void 0&&(t[e]=0),t[e]++}return t}toNum(r){if(r==null)return 0;if(typeof r=="number")return r>1.0001?r/100:r;let t=String(r).trim().replace(",",".");if(t.endsWith("%")){let e=parseFloat(t.slice(0,-1));return isNaN(e)?0:e/100}let s=parseFloat(t);return isNaN(s)?0:s>1.0001?s/100:s}parseCsv(r){let t=r.split(/\r?\n/).filter(n=>n.trim().length);if(!t.length)return[];let s=t[0].split(",").map(n=>n.trim()),e=[];for(let n=1;n<t.length;n++){let i=t[n].split(",");if(i.length!==s.length)continue;let a={};s.forEach((l,c)=>a[l]=(i[c]??"").trim()),e.push(a)}return e}normalizeModelRows(r){let t=(e,n)=>{for(let i of n){let a=e[i];if(a!=null)return String(a).trim()}return""},s=(e,n)=>{for(let i of n){let a=e[i];if(a!=null)return this.toNum(a)}return 0};return r.map(e=>{let n=t(e,["","Metric","metric","Unnamed: 0"]);if(!n){let c=t(e,["metric","Metric"]).toLowerCase(),p=t(e,["class","Class","classe","Classe"]);c&&p!==""&&(n=`${c}_class_${p}`)}let i=s(e,["mean"]),a=s(e,["lower_95_ci","lower_ci","lower"]),l=s(e,["upper_95_ci","upper_ci","upper"]);return{key:n,mean:i,lower:a,upper:l}}).filter(e=>e.key)}extractByMetricKey(r){let t=/^(precision|recall|f1)[\s_-]class[\s_-](\d+)/i,s={precision:[],recall:[],f1:[]};for(let e of r){let n=e.key.match(t);if(!n)continue;let i=n[1].toLowerCase(),a=Number(n[2]);s[i].push({class:a,mean:e.mean,lower:e.lower,upper:e.upper})}return["precision","recall","f1"].forEach(e=>{let n={};s[e].forEach(i=>n[i.class]=i),s[e]=[0,1,2].map(i=>n[i]??{class:i,mean:0,lower:0,upper:0})}),s}getBootstrapComparisons(){return u(this,null,function*(){let r=document.getElementsByTagName("base")[0],t=r&&r.getAttribute("href")||"/",s=t.endsWith("/")?t:t+"/",e=`${s}assets/data/sentiment/bootstrap_results_211124.json`,n=`${s}assets/data/sentiment/bootstrap/index.json`,i=[];try{let a=yield fetch(e);if(a.ok){let l=yield a.json(),c=this.normalizeModelRows(l),p=this.extractByMetricKey(c);i.push({model:"BERTimbau",metrics:p})}}catch(a){console.warn("[getBootstrapComparisons] baseline JSON indispon\xEDvel:",a)}try{let a=yield fetch(n);if(a.ok){let l=yield a.json();for(let c of l){let p=`${s}assets/data/sentiment/bootstrap/${c.file}`;try{let f=c.file.toLowerCase().endsWith(".json"),h=[],d=yield fetch(p);if(!d.ok)continue;if(f){let o=yield d.json();h=this.normalizeModelRows(o)}else{let o=yield d.text(),m=this.parseCsv(o);h=this.normalizeModelRows(m)}let g=this.extractByMetricKey(h);i.push({model:c.label||c.file,metrics:g})}catch(f){console.warn("[getBootstrapComparisons] falha ao ler",c.file,f)}}}}catch{}return i})}static \u0275fac=function(t){return new(t||b)(j(A))};static \u0275prov=v({token:b,factory:b.\u0275fac,providedIn:"root"})};export{S as a};
